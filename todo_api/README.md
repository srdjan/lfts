# Light-FP Todo API

This example shows how to build a backend-only HTTP API for managing tasks using the Light-FP TypeScript subset. The implementation follows the ports-and-adapters architecture with `domain/`, `ports/`, `adapters/`, and `http/` layers.

## Project Layout

```
todo_api/
  domain/      # Canonical types, schemas, and pure business logic
  ports/       # Interfaces that describe side-effect boundaries (storage, clock)
  adapters/    # Deno KV storage adapter plus system and test clocks
  http/        # Request handler that validates input and maps Results to HTTP
  main.ts      # Server entrypoint wiring dependencies and starting Deno.serve
```

## Prerequisites

- Deno 1.45+
- Deno KV (built into Deno 1.35+)

## Build & Run

Always compile schemas before running so the runtime sees the generated bytecode:

```sh
deno task todo:build
```

Start the API (defaults to port `8000`):

```sh
deno task todo:serve
```

Override the port if needed:

```sh
PORT=8787 deno task todo:serve
```

## Example Requests

The API emits JSON responses and expects JSON payloads. All inputs are validated at the boundary with `validate()`.

```sh
# Create a task
curl -X POST http://localhost:8000/tasks \
  -H "content-type: application/json" \
  -d '{"title":"Draft blog post","description":"Outline Light-FP article"}'

# List tasks
curl http://localhost:8000/tasks

# Get a single task
curl http://localhost:8000/tasks/<task-id>

# Update a task (mark completed)
curl -X PATCH http://localhost:8000/tasks/<task-id> \
  -H "content-type: application/json" \
  -d '{"state":{"type":"completed"}}'

# Delete a task
curl -X DELETE http://localhost:8000/tasks/<task-id>
```

Each create/update response includes the resulting domain events so you can forward them to other systems or tests.

## Testing

Domain logic is fully pure and covered by Deno tests:

```sh
deno test todo_api/tests/task.test.ts
```

## Notes

- Deno KV stores tasks under the `["task", <id>]` keyspace. Remove `todo_api/` or delete the KV directory to reset state.
- The HTTP layer translates domain+storage `Result` values into HTTP status codes (`409` for conflicts, `422` for validation issues, etc.).
- The `adapters/system_clock.ts` file also exports `createTestClock` you can use in higher-level tests.
